#!/bin/bash
set -e

# create OpenTAP group if it doesn't exist
getent group OpenTAP || groupadd OpenTAP && echo "Created OpenTAP group"

echo "Changing permissions of OpenTAP folder (/usr/share/OpenTAP)"
chgrp -R OpenTAP /usr/share/OpenTAP
# set sticky bit for the directory so new files will belong to the OpenTAP group
chmod -R g+rwxs /usr/share/OpenTAP

echo "OpenTAP group configured."

# Attempt to add a user to the OpenTAP group if a regular user installed OpenTAP using sudo.
if [ ! -z "$SUDO_USER" ]; then
  if [ ! "$SUDO_USER" == "root" ]; then
    usermod -a -G OpenTAP "$SUDO_USER"
    echo "Added user $SUDO_USER to the OpenTAP group"
  fi
fi

echo "A user must be a member of the OpenTAP group to use OpenTAP."
echo "Add users to the OpenTAP group with the following command:"
echo "    usermod -a -G OpenTAP \$USER"
echo "This OpenTAP install is global. If this is a multi-user system, consider creating a user-level OpenTAP install with"
echo "    tap package install OpenTAP --target /local/install/dir"
